<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/px-card/px-card.html">
<link rel="import" href="/bower_components/px-vis-timeseries/px-vis-timeseries.html">
<link rel="import" href="/bower_components/px-vis/px-vis-data.html">
<link rel="import" href="/bower_components/px-vis/px-vis-data-converter.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">

<!-- <script type="text/javascript" src="/bower_components/px/dist/px.min.js"></script> -->

<dom-module id="time-series-card">
  <template>
    <iron-ajax
          id="getTimeseries"
          auto=false
          method="POST"
          url="/predix-api/predix-timeseries/v1/datapoints"
          body="{{timeseriesBody}}"
          handle-as="json"
          content-type="application/json"
          last-response="{{data}}"
          on-response="_parseTSData"
    ></iron-ajax>
    <!-- Add in for "real time charts" -->
    <!-- <iron-ajax
          id="getLatestPoint"
          auto
          method="POST"
          url="/predix-api/predix-timeseries/v1/datapoints/latest"
          handle-as="json"
          body="[[latestPointBody]]"
          content-type="application/json"
          last-response="{{latest}}"
          on-response="_onResponse"
    ></iron-ajax> -->
    <!-- <iron-ajax
          id="getTags"
          auto
          method="GET"
          url="/predix-api/predix-timeseries/v1/tags"
          handle-as="json"
          content-type="application/json"
          last-response="{{tags.results}}"
          on-response="_tagResponse"
    ></iron-ajax> -->

    <px-card header-text="Time Series Card [[tagName]]">
      <px-chart>
        <px-chart-series-bar
          parent-component='["<px-chart>","</px-chart>"]'
          id="temp"
          name="[[tagName]]"
          marker='{"enabled":false,"radius":15}'
          data="{{tsData}}">
        </px-chart-series-bar>
      </px-chart>

      <px-vis-timeseries
        width="1100"
        height="600"
        prevent-resize="false"
        include-all-series
        register-location="side"
        selection-type= "xy"
        chart-data="{{tsData}}">
       </px-vis-timeseries>
    </px-card>
  </template>
</dom-module>
<script>
  Polymer({
    is: 'time-series-card',
    properties: {
      timeseriesBody: {
        type:Object,
        value:{
            "start": 1473899027861,
            "end": 1483890003000,
            "tags": [
                {
                    "name": [
                        "CoalPower-xlp-04"
                    ]
                }
            ]
        }
      },
      // latestPointBody: {
      //   type:Object,
      //   value:{
      //     "tags": [
      //       {
      //         "name": [
      //           "Temperature-xlp-trainer-03"
      //         ]
      //       }
      //     ]
      //   }
      // },
      // latestTSPoint: {
      //   type: Number
      // },
      tsData: {
        type: Array,
        value: []
      },
      tagName: {
        type: String
        //value: "Temperature-xlp-trainer-03"
      }
    },
    // _updateData: function(){
    //   this.async(function() {
    //     this.$.getLatestPoint.generateRequest();
    //   }, 10000);
    // },
    // _onResponse: function(e, details) {
    //   this._updateData();
    //   this.latestTSPoint = details.response.tags[0].results[0].values[0][1]; // latest.tags.0.results.0.values.0.1
    // },
    _parseTSData: function(e, details) {
      let data = details.response.tags[0].results[0].values;
      let arr = [];
      this.tagName = details.response.tags[0].name;
      data.forEach(function(point){
        point = {
          x: point[0],
          y: point[1]
        };
        arr.push(point);
      });
      this.set('tsData', arr);

    }
  });
</script>

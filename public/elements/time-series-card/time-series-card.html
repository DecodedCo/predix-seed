<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/px-card/px-card.html">
<link rel="import" href="/bower_components/px-vis-timeseries/px-vis-timeseries.html">
<link rel="import" href="/bower_components/px-vis/px-vis-data.html">
<link rel="import" href="/bower_components/px-vis/px-vis-data-converter.html">
<link rel="import" href="/bower_components/px-rangepicker/px-rangepicker.html">
<link rel="import" href="/bower_components/px-dropdown/px-dropdown.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/paper-toggle-button/paper-toggle-button.html">


<dom-module id="time-series-card">
  <template>
    <iron-ajax
          id="getTimeseries"
          method="POST"
          url="/predix-api/predix-timeseries/v1/datapoints"
          body="{{timeseriesBody}}"
          handle-as="json"
          content-type="application/json"
          last-response="{{data}}"
          on-response="_parseTSData"
    ></iron-ajax>
    <!-- Add in for "real time charts" -->
    <iron-ajax
          id="getLatestPoint"
          method="POST"
          url="/predix-api/predix-timeseries/v1/datapoints/latest"
          handle-as="json"
          body="[[latestPointBody]]"
          content-type="application/json"
          last-response="{{latest}}"
          on-response="_onResponse"
    ></iron-ajax>

    <px-card header-text="[[cardTitle]]" style="background-color:[[cardColor]]">
      <div style="padding:10px;display:inline-block;">
         <paper-toggle-button id="toggleBtn" checked> Historical Data </paper-toggle-button>
      </div>
      <div style="margin-bottom:1em; width:100%">
        <px-rangepicker
            style="width: 60%;display:inline-block;"
            id="tsRangePicker"
            block-future-dates="true"
            date-format="YYYY/MM/DD"
            time-format="hh:mm:ss A"
            show-buttons="true"
            hide-presets="true"
            hidden$="[[!historical]]"
            >
        </px-rangepicker>
        <div style="width:60%; display:inline-block;" hidden$="[[historical]]"></div>
        <px-dropdown id="dropdown"
          display-value="[[tags.0]]" style="width: 20%;display:inline-block;float:right;"
          hide-chevron="[[hideChevron]]"
          >
          <px-dropdown-content class="px-dropdown-content"
            extend-dropdown="true"
            extend-dropdown-by="25"
            max-cont-character-width="10"
            items='[[tags]]'
            hidden$="[[hideChevron]]"
            >
          </px-dropdown-content>
        </px-dropdown>
      </div>
      <px-chart hidden$="[[hideBar]]">
        <px-chart-series-bar
          parent-component='["<px-chart>","</px-chart>"]'
          id="temp"
          name="[[tagName]]"
          marker='{"enabled":false,"radius":15}'
          data="{{tsData}}">
        </px-chart-series-bar>
      </px-chart>
      <px-vis-timeseries hidden$="[[hideLine]]"
          height="300"
          include-all-series
          register-location="top"
          selection-type= "xy"
          chart-data="{{tsData}}">
      </px-vis-timeseries>
    </px-card>
  </template>
</dom-module>
<script>
  Polymer({
    is: 'time-series-card',
    properties: {
      timeseriesBody: {
        type:Object,
        value:{
            "start": "12h-ago",
            "end": "1mi-ago",
            "tags": []
        }
      },
      latestPointBody: {
        type:Object,
        value:{
          "tags": []
        }
      },
      tsData: {
        type: Array,
        value: []
      },
      tagName: {
        type: String
      },
      tags: {
        type: Array,
        observer: '_tags'
      },
      hideBar: {
        type: Boolean
      },
      hideLine: {
        type: Boolean
      },
      cardTitle: {
        type: String
      },
      hideChevron: {
        type: Boolean,
        value: true
      },
      cardColor: {
        type: String
      },
      historical: {
        type: Boolean,
        value: true
      }
    },
    ready: function ready(){
      let date = new Date();
      this.$.tsRangePicker.range = {
        "from": new Date(date.getTime() - 43200000).toISOString(), //"2016-01-01T01:00:00.000Z",
        "to": new Date(date.getTime()).toISOString()
      };
      this.$.tsRangePicker.addEventListener('px-datetime-range-submitted', () => {
        this._dateRangeChanged();
        this.$.getTimeseries.generateRequest();
      });
      this.$.dropdown.addEventListener('dropdown_content_value_changed', (e) => {
        this._tagChange(e.detail.textValue);
      });
      this.$.toggleBtn.addEventListener('change', (e) => {
          this.set('historical', !this.historical);
          this._tagChange(this.tagName);
      });
    },
    _tags: function(){
      if(this.tags.length > 0){
        if(this.tags.length > 1){
          this.hideChevron = false;
        }
        this._tagChange(this.tags[0]);
      }
    },
    _tagChange: function(tag){
      this.tagName = tag;
      this.timeseriesBody.tags = [
        {
          "name": [ tag ],
          "aggregations": [{
            "type": "avg",
            "sampling": {
              "unit": "s",
              "value": "45"
            }
          }]
        }
      ];
      this.latestPointBody.tags = [
        {
          "name": [ tag ]
        }
      ];
      this.$.getTimeseries.generateRequest();
    },
    _updateData: function(){
      this.async(function() {
        this.$.getLatestPoint.generateRequest();
      }, 10000);
    },
    _onResponse: function(e, details) {
      if(!this.historical){
        this._updateData();

        let latestPoint = details.response.tags[0].results[0].values[0];
        latestPoint = {
          x: latestPoint[0],
          y: latestPoint[1]
        }
        if(this.tsData.length > 0){
          if(latestPoint.x !== this.tsData[this.tsData.length-1].x){
            if(this.tsData.length > 500){ //limit the chart to 500 points?
              this.tsData.shift();
            }
            this.push('tsData', latestPoint);
          }
        }
        else {
          this.push('tsData', latestPoint);
        }
      }
    },
    _parseTSData: function(e, details) {
      let data = details.response.tags[0].results[0].values;
      let arr = [];
      this.tagName = details.response.tags[0].name;
      data.forEach(function(point){
        point = {
          x: point[0],
          y: point[1]
        };
        arr.push(point);
      });
      this.set('tsData', arr);

      if(!this.historical){
        this.$.getLatestPoint.generateRequest();
      }
    },
    _dateRangeChanged: function(){
      let start = +new Date(this.$.tsRangePicker.range.from);
      let end = +new Date(this.$.tsRangePicker.range.to);

      this.timeseriesBody.start = start;
      this.timeseriesBody.end = end;
    }
  });
</script>

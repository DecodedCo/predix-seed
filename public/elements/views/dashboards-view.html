<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/elements/bar-chart-card/bar-chart-card.html">
<link rel="import" href="/elements/scatter-plot-card/scatter-plot-card.html">
<link rel="import" href="/elements/time-series-card/time-series-card.html">
<link rel="import" href="/elements/values-card/values-card.html">
<link rel="import" href="/elements/latest-tag-data/latest-tag-data.html">
<link rel="import" href="/elements/aggregation-card/aggregation-card.html">
<link rel="import" href="/elements/pie-chart-card/pie-chart-card.html">
<link rel="import" href="/bower_components/px-alert-message/px-alert-message.html">
<style media="screen">
  .alert-message-container {
    position: fixed;
    top: 15px;
    right: 15px;
    z-index: 1020;
    height: 100vh;
  }
</style>

<dom-module id="dashboards-view">
  <template>

    <script type="text/javascript" src="../../bower_components/es6-promise/es6-promise.min.js"></script>

    <!-- Retrieve list of all tags -->
    <iron-ajax
          id="getTags"
          auto
          method="GET"
          url="/predix-api/predix-timeseries/v1/tags"
          handle-as="json"
          content-type="application/json"
          on-response="_tagResponse"
    ></iron-ajax>
    <div id="alert" class="alert-message-container">
    </div>

    <!-- Show latest value on one card per tag -->
    <span class="layout">
      <!-- Show realtime temperature -->
      <!-- <latest-data-card id="temperatureTag" class="layout__item"
        card-title="Gearbox Temperature (&deg;C)" tag="Temperature-xlp-[[deviceName]]" card-color="[[cardColor]]"></latest-data-card> -->
      <!-- <latest-data-card id="humidityTag" class="layout__item"
        card-title="Gearbox Humidity (%)" tag="Humidity-xlp-[[deviceName]]" card-color="[[cardColor]]"></latest-data-card> -->
      <!-- <latest-data-card id="CoalPowerTag" class="layout__item"
        card-title="Coal Power (MW)" tag="CoalPower-xlp-[[deviceName]]" card-color="[[cardColor]]" bound-value={{coalPower}}></latest-data-card> -->
      <!-- <latest-data-card id="GasPowerTag" class="layout__item"
        card-title="Gas Power (MW)" tag="GasPower-xlp-[[deviceName]]" card-color="[[cardColor]]" bound-value={{gasPower}}></latest-data-card> -->
      <!-- <latest-data-card id="WindPowerTag" class="layout__item"
        card-title="Wind Power (MW)" tag="WindPower-xlp-[[deviceName]]" card-color="[[cardColor]]" bound-value={{windPower}}></latest-data-card> -->
        <!-- <latest-data-card id="windSpeed" class="layout__item"
          card-title="Wind Speed (m/s)" tag="WindSpeed" card-color="[[cardColor]]"></latest-data-card> -->
      <latest-data-card id="TotalPowerTag" class="layout__item"
        card-title="Total Power (MW)" tag="TotalPower-xlp-[[deviceName]]" card-color="[[cardColor]]" bound-value={{output}}></latest-data-card>
      <latest-data-card id="demand" class="layout__item"
        card-title="Demand (MW)" tag="Demand" card-color="[[cardColor]]" bound-value={{demand}} threshold="[[thresholds.demand]]"></latest-data-card>
      <latest-data-card id="calculated" class="layout__item"
        card-title="Demand vs. Power" data-value="[[difference]]" value-name="Generated Power Needed" is-static card-color="[[cardColor]]"></latest-data-card>
    </span>
    <aggregation-card id="average" class="layout__item"
      card-title="Average Temperature" description="Average temperature over last 10 minutes" tag-name="Temperature-xlp-[[deviceName]]"
      aggregation-type="avg" card-color="[[cardColor]]" duration="1h"></aggregation-card>
    <!-- Pie chart - requires all power tags -->
    <!-- <pie-chart-card id="pieChart"
        card-title="Pie Chart" card-color="[[cardColor]]" pie-data="[[pieData]]"></pie-chart-card> -->

    <!-- Show time series for specific tags (any amount), no dropdown -->
    <time-series-card id="card0"
        card-title="Time Series Card - One tag" tags="[[_createTagsArray(tagVals.6)]]" hide-bar card-color="[[cardColor]]">
    </time-series-card>

    <time-series-card id="card1"
        card-title="Time Series Card - Line 1" tags="[[_createTagsArray('Temperature-xlp-54', tagVals.4)]]" hide-bar card-color="[[cardColor]]">
    </time-series-card>

    <!-- Show time series data as a line chart for all tags -->
    <time-series-card id="allTags"
        card-title="Time Series Card - Line" tags="[[tagVals]]" hide-bar card-color="[[cardColor]]">
    </time-series-card>

    <!-- Show time series data as a bar chart for all tags -->
<!--     <time-series-card id="tsBarChart"
        card-title="Time Series Card - Bar" tags="[[tagVals]]" hide-line card-color="[[cardColor]]">
    </time-series-card>
 -->
  </template>
  <script>

    // This is the device name you are using
    var deviceName = '54';

    Polymer({

      is: 'dashboards-view',

      properties: {
        tagVals: {
          type: Array
        },
        deviceName: {
          type: String,
          value: deviceName
        },
        cardColor: {
          type: String,
          value: "white"
        },
        demand: {
          type: Number,
          value: -1,
          notify: true,
          observer: '_demandHandler'
        },
        output: {
          type: Number,
          value: -1,
          notify: true,
          observer: '_outputHandler'
        },
        coalPower: {
          type: Number,
          value: -1,
          notify: true,
          observer: '_setPieData'
        },
        windPower: {
          type: Number,
          value: -1,
          observer: '_setPieData'
        },
        gasPower: {
          type: Number,
          value: -1,
          observer: '_setPieData'
        },
        pieData: {
          type: Array
        },
        thresholds: {
          type: Object,  // Object of threshold objects
          value: () => ({
              'demand': [   // each "set" of thresholds has a name and then an array of threshold info for multiple cases
                {
                  upper: 800,
                  lower: 0,
                  color: 'red',
                  apply: 'card'
                },
                {
                  upper: 800,
                  color: 'blue',
                  apply: 'text'
                }
              ]
          })
        }
      },
      compareDemandOutput: function(){
        // check if valid demand and output are being generated
        if(this.demand >= 0 && this.output >= 0) {
          // logic to trigger an alert
          if(this.demand > this.output){
            //create px-alert-message element
            var el = document.createElement("px-alert-message");
            el.type = "important";
            el.messageTitle = "Important!";
            el.message = "Demand is greater than total power output.";
            el.action = "dismiss";
            el.autoDismiss = "5000";
            // Uncomment the following line to show alerts
            // document.getElementById('alert').appendChild(el);
          }
        }
      },
      _tagResponse: function(e, details){
        let tags = details.response.results;
        let temp = [];

        tags.forEach((tag) => {
          if(tag.includes(deviceName) || tag.includes('Demand') || tag.includes('Windspeed')){
            temp.push(tag);
          };
        });
        this.set('tagVals', temp);
      },
      _createTagsArray: function(...tags){
        return tags;
      },
      _setPieData: function(){

        if(this.coalPower > -1 && this.gasPower > -1 && this.windPower > -1){
          this.pieData = [
            {
              "x": this.coalPower,
              "y": 'Coal Power'
            },
            {
              "x": this.windPower,
              "y": 'Wind Power'
            },
            {
              "x": this.gasPower,
              "y": 'Gas Power'
            }
          ];
        }
      },
      _calculateDifference: function(var1, var2, returnVar) {
        if(this[var1] && this[var2]){
          //return this[var1] - this[var2];
          this.set(returnVar, this[var1] - this[var2]);
        } else {
          this.set(returnVar, 'NA');
        }
      },
      _demandHandler: function() {
        this._calculateDifference('demand', 'output', 'difference');
        // put anything else here to happen when demand value is changed!
      },
      _outputHandler: function() {
        this._calculateDifference('demand', 'output', 'difference');
        // put anything else here to happen when output value is changed!
      }
    });
  </script>
</dom-module>
